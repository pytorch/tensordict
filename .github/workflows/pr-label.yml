# Automatically add a label to PRs based on the [Label] prefix in the title
#
# Usage:
#  - PR title must start with [Label] where Label is the desired label
#  - Example: "[Bug] Fix memory leak" will add the "Bug" label
#  - Fails if no [Label] prefix is found
#------------------------------------------------------------

name: PR Label

on:
  pull_request:
    types: [opened, edited]

jobs:
  add-label:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Parse and apply label from PR title
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          echo "PR Title: $PR_TITLE"

          # Check if title starts with [...]
          if [[ ! "$PR_TITLE" =~ ^\[([^\]]+)\] ]]; then
            echo "::error::PR title must start with [Label]. Got: '$PR_TITLE'"
            exit 1
          fi

          # Extract the label
          LABEL="${BASH_REMATCH[1]}"

          # Check if label is empty
          if [[ -z "$LABEL" ]]; then
            echo "::error::Label inside brackets cannot be empty"
            exit 1
          fi

          echo "Extracted label: $LABEL"

          # Validate against accepted labels
          ACCEPTED_LABELS="BugFix CI Compile Deprecation Docs Feature Perf Refactor Setup Test"
          FOUND=0
          for ACCEPTED in $ACCEPTED_LABELS; do
            if [[ "$LABEL" == "$ACCEPTED" ]]; then
              FOUND=1
              break
            fi
          done

          if [[ "$FOUND" -eq 0 ]]; then
            echo "::error::Label '$LABEL' is not in the accepted list: $ACCEPTED_LABELS"
            exit 1
          fi

          # Add the label to the PR
          gh pr edit "$PR_NUMBER" --repo "$REPO" --add-label "$LABEL"

          echo "Successfully added label '$LABEL' to PR #$PR_NUMBER"
