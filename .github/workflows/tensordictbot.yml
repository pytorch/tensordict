# @tensordictbot - PR management bot for tensordict
#
# Triggered by PR comments starting with `@tensordictbot`.
# See .github/tensordictbot/README.md for full documentation.
#
# Commands:
#   @tensordictbot merge [-f 'reason']   Merge a PR (ghstack land or squash merge)
#   @tensordictbot rebase [-b BRANCH]    Rebase PR onto a branch (default: main)
#   @tensordictbot help                  Show available commands

name: TensorDictBot

on:
  issue_comment:
    types: [created]

jobs:
  tensordictbot:
    # Only run on PR comments (not issue comments) that mention @tensordictbot
    if: >-
      github.event.issue.pull_request != null &&
      contains(github.event.comment.body, '@tensordictbot')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Full history needed for rebase operations
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install ghstack
        run: pip install ghstack

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Run tensordictbot
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_EVENT_PATH: ${{ github.event_path }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: python .github/tensordictbot/tensordictbot.py
